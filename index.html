<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coffee Log — Map</title>

  <!-- Mapbox + PapaParse -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body,#map{height:100%;margin:0}
    html,body{
      font:14px/1.35 system-ui,-apple-system,"Segoe UI",Roboto,Arial,
           "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji";
    }
    .badge{position:absolute;top:8px;left:8px;background:#fff;padding:6px 10px;border-radius:8px;font:14px/1.2 system-ui;box-shadow:0 2px 10px rgba(0,0,0,.06);z-index:5}
    :root{
      --card-bg: rgba(255,255,255,.86); --card-border: rgba(0,0,0,.06);
      --title: #0f1b10; --pill-bg: rgba(84,116,75,.12); --pill-br: rgba(84,116,75,.28);
      --glass: rgba(255,255,255,.9); --glass-br: rgba(0,0,0,.08); --text: #0f1b10;
      --muted: #5b5f5b;
    }
    body[data-theme="dark"]{
      --card-bg: rgba(22,24,27,.85); --card-border: rgba(255,255,255,.12);
      --title: #f3f5f1; --pill-bg: rgba(160,200,160,.14); --pill-br: rgba(190,230,190,.30);
      --glass: rgba(22,24,27,.9); --glass-br: rgba(255,255,255,.12); --text: #f3f5f1;
      --muted: #c9cdc8;
    }
    .mapboxgl-popup-content{ background:transparent; padding:0; border-radius:20px; box-shadow:none }
    .mapboxgl-popup-tip{ display:none }

    .popup-card{ position:relative; width:320px; max-width:90vw; border-radius:20px; overflow:hidden;
      background:var(--card-bg); border:1px solid var(--card-border); font:14px/1.35 system-ui }
    .popup-cover-box{ width:100%; height:200px; background:linear-gradient(180deg,#e7efe1,#f4f7f1) }
    .popup-cover{ width:100%; height:100%; object-fit:cover; display:block }
    .popup-body{ padding:14px }
    .popup-title{ font-weight:800; font-size:18px; margin:2px 0 6px; color:var(--title) }
    .process-badge{
      position:absolute; top:10px; right:10px; z-index:2;
      font-size:12px; padding:5px 10px; border-radius:999px;
      border:1px solid transparent; background:rgba(255,255,255,.8);
      backdrop-filter: blur(2px);
    }

    .collection-title{
      position:absolute; top:12px; left:50%; transform:translateX(-50%);
      background:var(--glass); color:var(--text); padding:8px 14px; border-radius:12px; border:1px solid var(--glass-br);
      z-index:5; white-space:nowrap; max-width:80vw; overflow:hidden; text-overflow:ellipsis; font:600 16px/1.2 system-ui
    }
    .meta{margin-bottom:6px;color:var(--muted)}
    a{color:#2b6cb0;text-decoration:none} a:hover{text-decoration:underline}
    .badge label{display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .badge input[type="checkbox"]{transform:translateY(1px)}

    /* Виджет ачивок (правый верх карты) */
    .achievements{position:absolute;top:12px;right:12px;z-index:6;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .ach-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--glass-br);font:12px/1.1 system-ui;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .ach-emoji{font-size:14px}
    .ach-title{font-weight:600}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="badge" id="badge">Загружаю данные…</div>
  <div class="achievements" id="achievements"></div>
  <div class="collection-title" id="collectionTitle">My coffee experience</div>

<script>
  /* ==== настройки ==== */
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibWF4MTQwNTE5OTMtY29mZmVlIiwiYSI6ImNtZTVic3c3dTBxZDMya3F6MzV0ejY1YjcifQ._YoZjruPVrVHtusEf8OkZw';
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSbms6-9Pie6VdyXzbjiMwWeIF-mxMvMiyFHaRI1DJE0nPNkSG99lewaeeU8YIuj7Y8vxzJGOD2md1v/pub?gid=1055803810&single=true&output=csv';
  
  const theme = (new URLSearchParams(location.search).get('style') || 'light').toLowerCase();
  document.body.dataset.theme = theme;
  const FLAG_MODE = (new URLSearchParams(location.search).get('flag') || 'img').toLowerCase(); // 'img' | 'emoji'

  /* ==== карта ==== */
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: theme === 'dark' ? 'mapbox://styles/mapbox/dark-v11' : 'mapbox://styles/mapbox/light-v11',
    center: [12, 20],
    zoom: 2.2,
    attributionControl: true
  });
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  map.on('load', () => {
    if (!map.getSource('terrain-dem')) {
      map.addSource('terrain-dem', { type: 'raster-dem', url: 'mapbox://mapbox.terrain-rgb', tileSize: 512 });
    }
    map.setTerrain({ source: 'terrain-dem', exaggeration: 1.6 });
    if (!map.getLayer('sky')) {
      map.addLayer({ id: 'sky', type: 'sky', paint: { 'sky-type':'atmosphere', 'sky-atmosphere-sun':[10,25], 'sky-atmosphere-sun-intensity': 10 } });
    }
    map.setFog({ range:[0.6, 12], color:'#f6efe7', 'high-color':'#d4c7b8', 'horizon-blend':0.2, 'star-intensity':0 });
  });

  /* ==== утилиты ==== */
  const normKey = (k) => String(k||'').toLowerCase().replace(/\s+/g,' ').trim();

  function pickSmart(row, candidates){
    for (const k of candidates) if (row[k] !== undefined && row[k] !== '') return row[k];
    const nRow = {}; for (const key in row) nRow[normKey(key)] = row[key];
    for (const cand of candidates){ const nCand = normKey(cand); if (nRow[nCand] !== undefined && nRow[nCand] !== '') return nRow[nCand]; }
    const allKeys = Object.keys(row);
    for (const cand of candidates){
      const nCand = normKey(cand);
      for (const key of allKeys){
        if (normKey(key).startsWith(nCand) && row[key] !== '') return row[key];
      }
    }
    return '';
  }

  const toNumber = (v) => (typeof v==='number') ? v : (typeof v==='string' ? parseFloat(v.replace(',', '.')) : NaN);
  const escapeHtml = (s) => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const escapeAttr = (s) => String(s||'').replace(/"/g,'&quot;');

  // === нормализация процесса + цвета ===
  function normalizeProcessName(raw){
    const s = String(raw||'').toLowerCase();
    if (!s) return 'other';
    if (/(honey|red honey|yellow honey|white honey|black honey)/.test(s)) return 'honey';
    if (/(anaer|carbonic|cm|термо|thermal|macerat|carbonique)/.test(s)) return 'anaerobic';
    if (/(wash|fully washed|wet|мыта|мытый|вымыт)/.test(s)) return 'washed';
    if (/(natur|dry|сух)/.test(s)) return 'natural';
    if (/(yeast|који|koji|enzym|фермент|co-?ferment|double|triple|wine)/.test(s)) return 'experimental';
    return 'other';
  }
  function processColors(pType){
    switch(pType){
      case 'washed':      return { point:'#2e7d32', bg:'#d7f0df', br:'#82b998', txt:'#205b3a' };
      case 'natural':     return { point:'#c0392b', bg:'#ffd9d2', br:'#e59883', txt:'#7a1d12' };
      case 'honey':       return { point:'#c77f0a', bg:'#ffe9c6', br:'#e9b86a', txt:'#6b4800' };
      case 'anaerobic':   return { point:'#6a3cbc', bg:'#e6d7ff', br:'#b79de5', txt:'#3b2b6f' };
      case 'experimental':return { point:'#2c5aa0', bg:'#dde9f7', br:'#9bb9e6', txt:'#1f3a63' };
      default:            return { point:'#777777', bg:'#eeeeee', br:'#cccccc', txt:'#333333' };
    }
  }

  // Drive helpers
  function extractDriveId(url){
    const m = String(url||'').match(/(?:\/d\/|id=)([-\w]{25,})/);
    return m ? m[1] : null;
  }
  function driveImgHtml(url){
    if (!url) return '';
    if (/thumbnail\?id=/.test(url)) return `<img class="popup-cover" loading="lazy" src="${escapeAttr(url)}" alt="photo">`;
    const id = extractDriveId(url);
    const chain = id ? [
      `https://drive.google.com/thumbnail?id=${id}&sz=w1600`,
      `https://lh3.googleusercontent.com/d/${id}=w1600`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ] : [url];
    const first = chain.shift();
    return `<img class="popup-cover" loading="lazy" src="${escapeAttr(first)}"
             alt="photo" onerror="driveImgFallback(this, ${JSON.stringify(chain)})">`;
  }
  function driveImgFallback(img, list){ if (!list || !list.length) { img.remove(); return; } img.src = list.shift(); }
  window.driveImgFallback = driveImgFallback;

  // флаг: emoji (если ?flag=emoji) → ISO2 PNG
  function flagFromRow(flagEmojiCell, iso2Cell){
    const emoji = String(flagEmojiCell||'').trim();
    if (FLAG_MODE==='emoji' && emoji) return emoji;
    const code = String(iso2Cell||'').trim().toLowerCase();
    return (code.length===2)
      ? `<img src="https://flagcdn.com/24x18/${code}.png" alt="${code.toUpperCase()}" width="24" height="18" style="vertical-align:-2px;border-radius:2px">`
      : (FLAG_MODE==='emoji' ? emoji : '');
  }

  /* ==== заголовки CSV ==== */
  const HEADERS = {
    timestamp:       ['Timestamp'],
    email:           ['Email Address'],
    uploader:        ['Uploader'],
    originCountry:   ['Origin country'],
    originRegion:    ['Origin region'],
    farmName:        ['Farm name'],
    process:         ['Process'],
    brewMethod:      ['Brew method'],
    whereConsumed:   ['Where consumed'],
    cafeName:        ['Cafe name'],
    cafeUrl:         ['Cafe URL'],
    consumedCity:    ['Consumed city','Consumed city '],
    consumedAddr:    ['Consumed address'],
    recipe:          ['Recipe'],
    roasterName:     ['Roaster name'],
    roasterCity:     ['Roaster city'],
    fileUpload:      ['File upload','File upload '],
    lat:             ['Latitude (lat)','Latitude'],
    lng:             ['Longitude (lng)','Longitude'],
    photoUrl:        ['Photo (URL)'],
    geocodeSource:   ['Geocode source'],
    geocodeAccuracy: ['Geocode accuracy'],
    matchedName:     ['Matched name'],
    countryIso2:     ['Country ISO2'],
    flagEmoji:       ['Flag emoji']
  };

  function rowsToGeoJSON(rows) {
    const features = [];
    for (const row of rows) {
      const lat = toNumber(pickSmart(row, HEADERS.lat));
      const lng = toNumber(pickSmart(row, HEADERS.lng));
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      let photo = pickSmart(row, HEADERS.photoUrl);
      if (!photo) photo = pickSmart(row, HEADERS.fileUpload);

      const processRaw  = pickSmart(row, HEADERS.process);
      const processNorm = normalizeProcessName(processRaw);

      const p = {
        timestamp:       pickSmart(row, HEADERS.timestamp),
        email:           pickSmart(row, HEADERS.email),
        uploader:        pickSmart(row, HEADERS.uploader),
        originCountry:   pickSmart(row, HEADERS.originCountry),
        originRegion:    pickSmart(row, HEADERS.originRegion),
        farmName:        pickSmart(row, HEADERS.farmName),
        process:         processRaw,
        process_norm:    processNorm,
        brewMethod:      pickSmart(row, HEADERS.brewMethod),
        whereConsumed:   pickSmart(row, HEADERS.whereConsumed),
        cafeName:        pickSmart(row, HEADERS.cafeName),
        cafeUrl:         pickSmart(row, HEADERS.cafeUrl),
        consumedCity:    pickSmart(row, HEADERS.consumedCity),
        consumedAddr:    pickSmart(row, HEADERS.consumedAddr),
        recipe:          pickSmart(row, HEADERS.recipe),
        roasterName:     pickSmart(row, HEADERS.roasterName),
        roasterCity:     pickSmart(row, HEADERS.roasterCity),
        photoUrl:        photo,
        matchedName:     pickSmart(row, HEADERS.matchedName),
        countryIso2:     pickSmart(row, HEADERS.countryIso2),
        flagEmoji:       pickSmart(row, HEADERS.flagEmoji)
      };

      features.push({ type:'Feature', geometry:{ type:'Point', coordinates:[lng,lat] }, properties:p });
    }
    return { type:'FeatureCollection', features };
  }

  function fitToData(geojson){
    if (!geojson.features.length) return;
    const b = new mapboxgl.LngLatBounds();
    geojson.features.forEach(f => b.extend(f.geometry.coordinates));
    map.fitBounds(b, { padding: 40, duration: 700, maxZoom: 10 });
  }

  /* ==== карточка ==== */
  function popupHTML(p) {
    const flag = flagFromRow(p.flagEmoji, p.countryIso2);
    const country = p.originCountry ? ((flag ? flag + ' ' : '') + escapeHtml(p.originCountry)) : '';
    const region  = escapeHtml(p.originRegion || '');
    const place   = [country, region].filter(Boolean).join(', ');
    const roaster = (p.roasterName ? escapeHtml(p.roasterName) : '') +
                    (p.roasterCity ? ' (' + escapeHtml(p.roasterCity) + ')' : '');
    const photo = `<div class="popup-cover-box">${ p.photoUrl ? driveImgHtml(p.photoUrl) : '' }</div>`;

    const rows = [];
    if (p.brewMethod)    rows.push(row('Method',  p.brewMethod));
    if (p.whereConsumed || p.consumedCity || p.consumedAddr || p.cafeUrl) {
      const whereBits = [];
      if (p.whereConsumed) whereBits.push(escapeHtml(p.whereConsumed));
      if (p.consumedCity)  whereBits.push(escapeHtml(p.consumedCity));
      if (p.cafeUrl)       rows.push(row('Link', `<a href="${escapeAttr(p.cafeUrl)}" target="_blank" rel="noopener">link</a>`));
      rows.push(row('Where', whereBits.join(' — ')));
      if (p.consumedAddr) rows.push(`<div style="margin:2px 0;color:#666">${escapeHtml(p.consumedAddr)}</div>`);
    }
    if (p.recipe)        rows.push(row('Recipe',  p.recipe));
    if (roaster)         rows.push(row('Roaster', roaster));
    if (p.uploader)      rows.push(row('By',      p.uploader));

    const pType = p.process_norm || 'other';
    const col = processColors(pType);
    const badge = p.process
      ? `<div class="process-badge" style="background:${col.bg};border-color:${col.br};color:${col.txt}">${escapeHtml(p.process)}</div>`
      : '';

    return `
      <div class="popup-card">
        ${badge}
        ${photo}
        <div class="popup-body">
          <div class="popup-title">${escapeHtml(p.farmName || 'Без названия')}</div>
          <div class="meta">${place || '—'}</div>
          ${rows.join('')}
        </div>
      </div>
    `;

    function row(label, val){
      return `<div style="margin:2px 0"><span style="color:#666">${escapeHtml(label)}: </span>${typeof val==='string'?val:val||''}</div>`;
    }
  }

  /* ==== линии: геокодинг + кеш ==== */
  const CITY_CACHE_NS = 'coffee_city_cache_v1';
  const cityCache = JSON.parse(localStorage.getItem(CITY_CACHE_NS) || '{}');
  const cacheSave = () => localStorage.setItem(CITY_CACHE_NS, JSON.stringify(cityCache));

  async function geocodeCityName(name){
    const key = String(name||'').trim().toLowerCase();
    if (!key) return null;
    if (cityCache[key]) return cityCache[key];
    const url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' +
      encodeURIComponent(name) + '.json?' + new URLSearchParams({
        access_token: MAPBOX_TOKEN, types: 'place,locality', language: 'ru,en', limit: '1'
      });
    const res = await fetch(url);
    if (!res.ok) return null;
    const json = await res.json();
    const f = (json.features||[])[0];
    if (!f || !Array.isArray(f.center)) return null;
    const [lng, lat] = f.center;
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
    const pt = {lng, lat};
    cityCache[key] = pt; cacheSave();
    return pt;
  }

  async function geocodeCities(names){
    const out = {};
    for (const name of names){ out[name] = await geocodeCityName(name); }
    return out;
  }

  function buildRouteFeatures(pointFeatures, cityMap){
    const lines = [];
    for (const f of pointFeatures){
      const p = f.properties;
      const [farmLng, farmLat] = f.geometry.coordinates;

      if (p.roasterCity){
        const rc = cityMap[p.roasterCity];
        if (rc){
          lines.push({
            type:'Feature',
            geometry:{ type:'LineString', coordinates:[[farmLng,farmLat],[rc.lng,rc.lat]] },
            properties:{ kind:'farm_to_roaster', farm:p.farmName||'', roasterCity:p.roasterCity||'' }
          });
        }
      }
      if (p.roasterCity && p.consumedCity){
        const rc = cityMap[p.roasterCity];
        const uc = cityMap[p.consumedCity];
        if (rc && uc){
          lines.push({
            type:'Feature',
            geometry:{ type:'LineString', coordinates:[[rc.lng,rc.lat],[uc.lng,uc.lat]] },
            properties:{ kind:'roaster_to_consumed', roasterCity:p.roasterCity||'', consumedCity:p.consumedCity||'' }
          });
        }
      }
    }
    return lines;
  }

  function highlightRouteFor(p){
    if (!map.getLayer('route-highlight')) return;
    const filt = ['any'];
    if (p.roasterCity){
      filt.push(['all',
        ['==',['get','kind'],'farm_to_roaster'],
        ['==',['get','roasterCity'], String(p.roasterCity)]
      ]);
      if (p.consumedCity){
        filt.push(['all',
          ['==',['get','kind'],'roaster_to_consumed'],
          ['==',['get','roasterCity'], String(p.roasterCity)],
          ['==',['get','consumedCity'], String(p.consumedCity)]
        ]);
      }
    }
    map.setFilter('route-highlight', filt.length>1 ? filt : ['==', ['get','kind'], '___nope___']);
  }
  function clearRouteHighlight(){
    if (map.getLayer('route-highlight')){
      map.setFilter('route-highlight', ['==', ['get','kind'], '___nope___']);
    }
  }

  /* ==== страны-заливка ==== */
  const WORLDVIEW = 'US';
  function getVisitedCountriesIso2(pointFeatures){
    const set = new Set();
    for (const f of pointFeatures){
      const c = String(f.properties?.countryIso2 || '').trim().toUpperCase();
      if (/^[A-Z]{2}$/.test(c)) set.add(c);
    }
    return set;
  }
  function buildVisitedFilter(iso2List){
    return [
      'all',
      ['==', ['get','disputed'], 'false'],
      ['any', ['==','all',['get','worldview']], ['in', WORLDVIEW, ['get','worldview']]],
      ['in', ['get','iso_3166_1'], ['literal', iso2List]]
    ];
  }
  function ensureCountriesLayers(){
    if (!map.getSource('countries')){
      map.addSource('countries', { type:'vector', url:'mapbox://mapbox.country-boundaries-v1' });
    }
    const beforeId = 'admin-1-boundary-bg';
    if (!map.getLayer('countries-visited-fill')){
      map.addLayer({
        id:'countries-visited-fill',
        type:'fill',
        source:'countries',
        'source-layer':'country_boundaries',
        paint:{ 'fill-color':'#76a96b', 'fill-opacity':0.35 }
      }, beforeId);
      map.setLayoutProperty('countries-visited-fill','visibility','none');
    }
    if (!map.getLayer('countries-visited-outline')){
      map.addLayer({
        id:'countries-visited-outline',
        type:'line',
        source:'countries',
        'source-layer':'country_boundaries',
        paint:{ 'line-color':'#567a58', 'line-width':0.8, 'line-opacity':0.85 }
      }, beforeId);
      map.setLayoutProperty('countries-visited-outline','visibility','none');
    }
  }
  function setCountriesVisibility(state){
    const vis = state ? 'visible' : 'none';
    if (map.getLayer('countries-visited-fill'))   map.setLayoutProperty('countries-visited-fill',   'visibility', vis);
    if (map.getLayer('countries-visited-outline'))map.setLayoutProperty('countries-visited-outline','visibility', vis);
  }

  /* ==== Ачивки ==== */
  const ACHIEVEMENTS = [
    {
      id:'first_sip', emoji:'☕️', title:'Первый глоток',
      color:{ bg:'#d1fae5', br:'#99f6e4', txt:'#065f46' },
      earned:(m)=> m.total >= 1
    },
    {
      id:'countries_3', emoji:'🌍', title:'Страны ×3',
      color:{ bg:'#fef3c7', br:'#fde68a', txt:'#92400e' },
      earned:(m)=> m.countries >= 3
    },
    {
      id:'processes_3', emoji:'🧪', title:'Процессы ×3',
      color:{ bg:'#ede9fe', br:'#ddd6fe', txt:'#4c1d95' },
      earned:(m)=> m.processTypes >= 3
    }
  ];
  function computeMetrics(pointFeatures){
    const countriesSet = getVisitedCountriesIso2(pointFeatures);
    const proc = new Set();
    for (const f of pointFeatures){
      const t = (f.properties?.process_norm)||'';
      if (t && t !== 'other') proc.add(t);
    }
    return {
      total: pointFeatures.length,
      countries: countriesSet.size,
      processTypes: proc.size,
      _countriesSet: countriesSet, _procSet: proc
    };
  }
  function renderAchievements(metrics){
    const earned = ACHIEVEMENTS.filter(a => a.earned(metrics));
    const el = document.getElementById('achievements');
    if (!earned.length){ el.innerHTML = ''; return; }
    el.innerHTML = earned.map(a =>
      `<div class="ach-badge" style="background:${a.color.bg};border-color:${a.color.br};color:${a.color.txt}" title="${escapeAttr(a.title)}">
         <span class="ach-emoji">${a.emoji}</span><span class="ach-title">${escapeHtml(a.title)}</span>
       </div>`
    ).join('');
  }

  /* ==== загрузка CSV → точки + линии + страны + ачивки ==== */
  Papa.parse(CSV_URL, {
    download: true, header: true, dynamicTyping: false,
    complete: async (results) => {
      const geojsonPoints = rowsToGeoJSON(results.data || []);
      const pointFeatures = geojsonPoints.features;

      // города для линий
      const want = new Set();
      for (const f of pointFeatures){
        const p = f.properties;
        if (p.roasterCity)  want.add(String(p.roasterCity).trim());
        if (p.consumedCity) want.add(String(p.consumedCity).trim());
      }
      const uniqueCities = [...want].filter(Boolean);
      const cityCoordsMap = await geocodeCities(uniqueCities);
      const lineFeatures = buildRouteFeatures(pointFeatures, cityCoordsMap);
      const geojsonLines = { type:'FeatureCollection', features: lineFeatures };

      // страны
      const visitedSet  = getVisitedCountriesIso2(pointFeatures);
      const visitedList = [...visitedSet];

      // бейдж слева
      const badgeEl = document.getElementById('badge');
      badgeEl.innerHTML =
        `Точек: ${pointFeatures.length} · Стран: ${visitedList.length}<br>` +
        `<label><input type="checkbox" id="toggleVisited"> Закрашивать страны</label>`;

      // ачивки (справа)
      const metrics = computeMetrics(pointFeatures);
      renderAchievements(metrics);

      function addLayers(){
        // источники
        if (!map.getSource('brews')) {
          map.addSource('brews', { type:'geojson', data:geojsonPoints, cluster:true, clusterMaxZoom:14, clusterRadius:50 });
        } else {
          map.getSource('brews').setData(geojsonPoints);
        }
        if (!map.getSource('routes')) {
          map.addSource('routes', { type:'geojson', data:geojsonLines });
        } else {
          map.getSource('routes').setData(geojsonLines);
        }

        // страны
        ensureCountriesLayers();
        const filt = buildVisitedFilter(visitedList);
        map.setFilter('countries-visited-fill', filt);
        map.setFilter('countries-visited-outline', filt);
        setCountriesVisibility(false);

        // линии
        if (!map.getLayer('route-farm-roaster')){
          map.addLayer({
            id:'route-farm-roaster', type:'line', source:'routes',
            filter:['==',['get','kind'],'farm_to_roaster'],
            paint:{ 'line-color':'#006d2c', 'line-width':2, 'line-opacity':0.6 }
          });
        }
        if (!map.getLayer('route-roaster-consumed')){
          map.addLayer({
            id:'route-roaster-consumed', type:'line', source:'routes',
            filter:['==',['get','kind'],'roaster_to_consumed'],
            paint:{ 'line-color':'#08519c', 'line-width':2, 'line-opacity':0.6, 'line-dasharray':[2,2] }
          });
        }
        if (!map.getLayer('route-highlight')){
          map.addLayer({
            id:'route-highlight', type:'line', source:'routes',
            filter:['==', ['get','kind'], '___nope___'],
            paint:{ 'line-color':'#ff7f00', 'line-width':5, 'line-opacity':0.9 }
          });
        }

        // кластеры и точки (цвет по process_norm)
        if (!map.getLayer('clusters')){
          map.addLayer({
            id:'clusters', type:'circle', source:'brews', filter:['has','point_count'],
            paint:{
              'circle-color': ['step',['get','point_count'],'#9ecae1',10,'#6baed6',30,'#3182bd'],
              'circle-radius': ['step',['get','point_count'],16,10,20,30,26]
            }
          });
          map.addLayer({
            id:'cluster-count', type:'symbol', source:'brews', filter:['has','point_count'],
            layout:{ 'text-field': ['get','point_count_abbreviated'], 'text-size':12 },
            paint:{ 'text-color':'#08306b' }
          });
          map.addLayer({
            id:'unclustered', type:'circle', source:'brews', filter:['!', ['has','point_count']],
            paint:{
              'circle-color': [
                'match', ['get','process_norm'],
                'washed',      '#2e7d32',
                'natural',     '#c0392b',
                'honey',       '#c77f0a',
                'anaerobic',   '#6a3cbc',
                'experimental','#2c5aa0',
                /* other */    '#777777'
              ],
              'circle-radius':6,
              'circle-stroke-width':1,
              'circle-stroke-color':'#fff'
            }
          });

          map.on('click','clusters',(e)=>{
            const f = map.queryRenderedFeatures(e.point,{layers:['clusters']})[0];
            map.getSource('brews').getClusterExpansionZoom(f.properties.cluster_id,(err,zoom)=>{
              if (!err) map.easeTo({center:f.geometry.coordinates, zoom});
            });
          });
          map.on('click','unclustered',(e)=>{
            const f = e.features[0];
            new mapboxgl.Popup({ offset:12, maxWidth:'360px' })
              .setLngLat(f.geometry.coordinates)
              .setHTML(popupHTML(f.properties))
              .addTo(map);
            highlightRouteFor(f.properties);
          });

          map.on('click', (e) => {
            const feats = map.queryRenderedFeatures(e.point, {layers:['unclustered','clusters']});
            if (!feats.length) clearRouteHighlight();
          });

          map.on('mouseenter','clusters',()=>map.getCanvas().style.cursor='pointer');
          map.on('mouseleave','clusters',()=>map.getCanvas().style.cursor='');
          map.on('mouseenter','unclustered',()=>map.getCanvas().style.cursor='pointer');
          map.on('mouseleave','unclustered',()=>map.getCanvas().style.cursor='');
        }

        fitToData(geojsonPoints);
      }

      if (map.isStyleLoaded && map.isStyleLoaded()) addLayers();
      else map.on('load', addLayers);

      // чекбокс стран
      document.getElementById('toggleVisited')?.addEventListener('change', (e)=>{
        setCountriesVisibility(e.target.checked);
      });
    },
    error: (err) => {
      document.getElementById('badge').textContent = 'Ошибка загрузки CSV';
      console.error('CSV error:', err);
    }
  });

  // Заголовок
  document.getElementById('collectionTitle').textContent = 'My coffee experience';
</script>
</body>
</html>
