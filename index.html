<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coffee Log — Map</title>

  <!-- Mapbox + PapaParse -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body,#map{height:100%;margin:0}
    html,body{
      font:14px/1.35 system-ui,-apple-system,"Segoe UI",Roboto,Arial,
           "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji";
    }
    .badge{position:absolute;top:8px;left:8px;background:#fff;padding:6px 10px;border-radius:8px;font:14px/1.2 system-ui;box-shadow:0 2px 10px rgba(0,0,0,.06);z-index:5}
    :root{
      --card-bg: rgba(255,255,255,.86); --card-border: rgba(0,0,0,.06);
      --title: #0f1b10; --pill-bg: rgba(84,116,75,.12); --pill-br: rgba(84,116,75,.28);
      --glass: rgba(255,255,255,.9); --glass-br: rgba(0,0,0,.08); --text: #0f1b10;
      --muted: #5b5f5b;
    }
    body[data-theme="dark"]{
      --card-bg: rgba(22,24,27,.85); --card-border: rgba(255,255,255,.12);
      --title: #f3f5f1; --pill-bg: rgba(160,200,160,.14); --pill-br: rgba(190,230,190,.30);
      --glass: rgba(22,24,27,.9); --glass-br: rgba(255,255,255,.12); --text: #f3f5f1;
      --muted: #c9cdc8;
    }
    .mapboxgl-popup-content{ background:transparent; padding:0; border-radius:20px; box-shadow:none }
    .mapboxgl-popup-tip{ display:none }
    .popup-card{ width:320px; max-width:90vw; border-radius:20px; overflow:hidden;
      background:var(--card-bg); border:1px solid var(--card-border); font:14px/1.35 system-ui }
    .popup-cover-box{ width:100%; height:200px; background:linear-gradient(180deg,#e7efe1,#f4f7f1) }
    .popup-cover{ width:100%; height:100%; object-fit:cover; display:block }
    .popup-body{ padding:14px }
    .popup-title{ font-weight:800; font-size:18px; margin:2px 0 6px; color:var(--title) }
    .process-pill{ font-size:12px; padding:5px 10px; border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-br); color:var(--title); margin-left:auto }
    .collection-title{
      position:absolute; top:12px; left:50%; transform:translateX(-50%);
      background:var(--glass); color:var(--text); padding:8px 14px; border-radius:12px; border:1px solid var(--glass-br);
      z-index:5; white-space:nowrap; max-width:80vw; overflow:hidden; text-overflow:ellipsis; font:600 16px/1.2 system-ui
    }
    .meta{margin-bottom:6px;color:var(--muted)}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--pill-br);background:var(--pill-bg);font-size:12px;color:var(--title)}
    a{color:#2b6cb0;text-decoration:none} a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="badge" id="badge">Загружаю данные…</div>
  <div class="collection-title" id="collectionTitle">My coffee experience</div>

<script>
  /* ==== настройки ==== */
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibWF4MTQwNTE5OTMtY29mZmVlIiwiYSI6ImNtZTVic3c3dTBxZDMya3F6MzV0ejY1YjcifQ._YoZjruPVrVHtusEf8OkZw';
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5ft53W2ettUoEJqOyaJFoySOEbGr14qomprmDRlCwI0F3WEhnTn6IybbqgP_q9yv23sfNeqlPN5x/pub?output=csv';

  const theme = (new URLSearchParams(location.search).get('style') || 'light').toLowerCase();
  document.body.dataset.theme = theme;
  const FLAG_MODE = (new URLSearchParams(location.search).get('flag') || 'img').toLowerCase(); // 'img' | 'emoji'

  /* ==== карта ==== */
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: theme === 'dark' ? 'mapbox://styles/mapbox/dark-v11' : 'mapbox://styles/mapbox/light-v11',
    center: [12, 20],
    zoom: 2.2,
    attributionControl: true
  });
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  map.on('load', () => {
    if (!map.getSource('terrain-dem')) {
      map.addSource('terrain-dem', { type: 'raster-dem', url: 'mapbox://mapbox.terrain-rgb', tileSize: 512 });
    }
    map.setTerrain({ source: 'terrain-dem', exaggeration: 1.6 });
    if (!map.getLayer('sky')) {
      map.addLayer({ id: 'sky', type: 'sky', paint: { 'sky-type':'atmosphere', 'sky-atmosphere-sun':[10,25], 'sky-atmosphere-sun-intensity': 10 } });
    }
    map.setFog({ range:[0.6, 12], color:'#f6efe7', 'high-color':'#d4c7b8', 'horizon-blend':0.2, 'star-intensity':0 });
  });

  /* ==== утилиты ==== */
  const normKey = (k) => String(k||'').toLowerCase().replace(/\s+/g,' ').trim();

  // Расширенный пикер: 1) точное имя 2) нормализованное имя 3) любой ключ, который НАЧИНАЕТСЯ с шаблона (для дубликатов "Cafe URL", "Cafe URL_1", "Consumed city   " и т.п.)
  function pickSmart(row, candidates){
    // 1) прямое совпадение
    for (const k of candidates) if (row[k] !== undefined && row[k] !== '') return row[k];

    // нормализованная карта ключей
    const nRow = {};
    for (const key in row) nRow[normKey(key)] = row[key];

    // 2) точное сравнение нормализованных
    for (const cand of candidates){
      const nCand = normKey(cand);
      if (nRow[nCand] !== undefined && nRow[nCand] !== '') return nRow[nCand];
    }

    // 3) префиксный матч (берём первый непустой)
    const allKeys = Object.keys(row);
    for (const cand of candidates){
      const nCand = normKey(cand);
      for (const key of allKeys){
        if (normKey(key).startsWith(nCand) && row[key] !== '') return row[key];
      }
    }
    return '';
  }

  const toNumber = (v) => (typeof v==='number') ? v : (typeof v==='string' ? parseFloat(v.replace(',', '.')) : NaN);
  const escapeHtml = (s) => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const escapeAttr = (s) => String(s||'').replace(/"/g,'&quot;');

  // Drive helpers (для Photo (URL) и любых прямых drive-ссылок)
  function extractDriveId(url){
    const m = String(url||'').match(/(?:\/d\/|id=)([-\w]{25,})/);
    return m ? m[1] : null;
  }
  function driveImgHtml(url){
    if (!url) return '';
    // если это уже наш thumbnail — просто вставляем
    if (/thumbnail\?id=/.test(url)) {
      return `<img class="popup-cover" loading="lazy" src="${escapeAttr(url)}" alt="photo">`;
    }
    const id = extractDriveId(url);
    const chain = id ? [
      `https://drive.google.com/thumbnail?id=${id}&sz=w1600`,
      `https://lh3.googleusercontent.com/d/${id}=w1600`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ] : [url];
    const first = chain.shift();
    return `<img class="popup-cover" loading="lazy" src="${escapeAttr(first)}"
             alt="photo" onerror="driveImgFallback(this, ${JSON.stringify(chain)})">`;
  }
  function driveImgFallback(img, list){
    if (!list || !list.length) { img.remove(); return; }
    img.src = list.shift();
  }
  window.driveImgFallback = driveImgFallback; // используется в onerror

  // приоритет флага: эмоджи из таблицы (если ?flag=emoji) → ISO2 PNG → пусто
  function flagFromRow(flagEmojiCell, iso2Cell){
    const emoji = String(flagEmojiCell||'').trim();
    if (FLAG_MODE==='emoji' && emoji) return emoji;
    const code = String(iso2Cell||'').trim().toLowerCase();
    if (code.length===2){
      return `<img src="https://flagcdn.com/24x18/${code}.png" alt="${code.toUpperCase()}"
               width="24" height="18" style="vertical-align:-2px;border-radius:2px">`;
    }
    return FLAG_MODE==='emoji' ? emoji : '';
  }

  /* ==== заголовки CSV (с дубликатами) ==== */
  const HEADERS = {
    timestamp:       ['Timestamp'],
    email:           ['Email Address'],
    uploader:        ['Uploader'],
    originCountry:   ['Origin country'],
    originRegion:    ['Origin region'],
    farmName:        ['Farm name'],
    process:         ['Process'],
    brewMethod:      ['Brew method'],
    whereConsumed:   ['Where consumed'],
    cafeName:        ['Cafe name'],
    cafeUrl:         ['Cafe URL'],                 // есть дубликат — pickSmart найдёт первый непустой, включая "Cafe URL_1"
    consumedCity:    ['Consumed city','Consumed city '], // учтён вариант с пробелами
    consumedAddr:    ['Consumed address'],
    recipe:          ['Recipe'],
    roasterName:     ['Roaster name'],
    roasterCity:     ['Roaster city'],
    fileUpload:      ['File upload','File upload '], // Google иногда добавляет пробел
    lat:             ['Latitude (lat)','Latitude'],
    lng:             ['Longitude (lng)','Longitude'],
    photoUrl:        ['Photo (URL)'],             // при пустом возьмём fileUpload
    geocodeSource:   ['Geocode source'],
    geocodeAccuracy: ['Geocode accuracy'],
    matchedName:     ['Matched name'],
    countryIso2:     ['Country ISO2'],
    flagEmoji:       ['Flag emoji']
  };

  function rowsToGeoJSON(rows) {
    const features = [];
    for (const row of rows) {
      const lat = toNumber(pickSmart(row, HEADERS.lat));
      const lng = toNumber(pickSmart(row, HEADERS.lng));
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      // фото: сначала Photo (URL), если пусто — попробуем File upload (могут быть ссылки на drive)
      let photo = pickSmart(row, HEADERS.photoUrl);
      if (!photo) photo = pickSmart(row, HEADERS.fileUpload);

      // cafe url: учитываем дубликаты "Cafe URL", "Cafe URL_1", … (pickSmart уже умеет)
      const cafeUrl = pickSmart(row, HEADERS.cafeUrl);

      const p = {
        timestamp:       pickSmart(row, HEADERS.timestamp),
        email:           pickSmart(row, HEADERS.email),
        uploader:        pickSmart(row, HEADERS.uploader),
        originCountry:   pickSmart(row, HEADERS.originCountry),
        originRegion:    pickSmart(row, HEADERS.originRegion),
        farmName:        pickSmart(row, HEADERS.farmName),
        process:         pickSmart(row, HEADERS.process),
        brewMethod:      pickSmart(row, HEADERS.brewMethod),
        whereConsumed:   pickSmart(row, HEADERS.whereConsumed),
        cafeName:        pickSmart(row, HEADERS.cafeName),
        cafeUrl:         cafeUrl,
        consumedCity:    pickSmart(row, HEADERS.consumedCity),
        consumedAddr:    pickSmart(row, HEADERS.consumedAddr),
        recipe:          pickSmart(row, HEADERS.recipe),
        roasterName:     pickSmart(row, HEADERS.roasterName),
        roasterCity:     pickSmart(row, HEADERS.roasterCity),
        photoUrl:        photo,
        geocodeSource:   pickSmart(row, HEADERS.geocodeSource),
        geocodeAccuracy: pickSmart(row, HEADERS.geocodeAccuracy),
        matchedName:     pickSmart(row, HEADERS.matchedName),
        countryIso2:     pickSmart(row, HEADERS.countryIso2),
        flagEmoji:       pickSmart(row, HEADERS.flagEmoji)
      };

      features.push({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [lng, lat] },
        properties: p
      });
    }
    return { type: 'FeatureCollection', features };
  }

  function fitToData(geojson){
    if (!geojson.features.length) return;
    const b = new mapboxgl.LngLatBounds();
    geojson.features.forEach(f => b.extend(f.geometry.coordinates));
    map.fitBounds(b, { padding: 40, duration: 700, maxZoom: 10 });
  }

  /* ==== карточка ==== */
  function popupHTML(p) {
    const flag = flagFromRow(p.flagEmoji, p.countryIso2);
    const country = p.originCountry ? ((flag ? flag + ' ' : '') + escapeHtml(p.originCountry)) : '';
    const region  = escapeHtml(p.originRegion || '');
    const place   = [country, region].filter(Boolean).join(', ');
    const roaster = (p.roasterName ? escapeHtml(p.roasterName) : '') +
                    (p.roasterCity ? ' (' + escapeHtml(p.roasterCity) + ')' : '');
    const process = p.process ? `<span class="process-pill">${escapeHtml(p.process)}</span>` : '';
    const photo = `<div class="popup-cover-box">${
      p.photoUrl ? driveImgHtml(p.photoUrl) : ''
    }</div>`;

    const rows = [];
    if (p.process)       rows.push(row('Process', p.process));
    if (p.brewMethod)    rows.push(row('Method',  p.brewMethod));
    // Где пил
    if (p.whereConsumed || p.consumedCity || p.consumedAddr || p.cafeUrl) {
      const whereBits = [];
      if (p.whereConsumed) whereBits.push(escapeHtml(p.whereConsumed));
      if (p.consumedCity)  whereBits.push(escapeHtml(p.consumedCity));
      if (p.cafeUrl)       whereBits.push(`<a href="${escapeAttr(p.cafeUrl)}" target="_blank" rel="noopener">link</a>`);
      rows.push(row('Where', whereBits.join(' — ')));
      if (p.consumedAddr) rows.push(`<div style="margin:2px 0;color:#666">${escapeHtml(p.consumedAddr)}</div>`);
    }
    if (p.recipe)        rows.push(row('Recipe',  p.recipe));
    if (roaster)         rows.push(row('Roaster', roaster));
    if (p.uploader)      rows.push(row('By',      p.uploader));

    // геокодинг-чипы (если есть)
    const chips = [];
    if (p.geocodeSource)   chips.push(`<span class="chip">src: ${escapeHtml(p.geocodeSource)}</span>`);
    if (p.geocodeAccuracy) chips.push(`<span class="chip">acc: ${escapeHtml(p.geocodeAccuracy)}</span>`);
    if (p.matchedName)     chips.push(`<span class="chip">${escapeHtml(p.matchedName)}</span>`);
    const chipsLine = chips.length ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 2px">${chips.join('')}</div>` : '';

    return `
      <div class="popup-card">
        ${photo}
        <div class="popup-body">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <div class="popup-title" style="flex:1">${escapeHtml(p.farmName || 'Без названия')}</div>
            ${process}
          </div>
          <div class="meta">${place || '—'}</div>
          ${chipsLine}
          ${rows.join('')}
        </div>
      </div>
    `;

    function row(label, val){
      return `<div style="margin:2px 0"><span style="color:#666">${escapeHtml(label)}: </span>${typeof val==='string'?escapeHtml(val):val||''}</div>`;
    }
  }

  /* ==== загрузка CSV → слои ==== */
  Papa.parse(CSV_URL, {
    download: true, header: true, dynamicTyping: false,
    complete: (results) => {
      const geojson = rowsToGeoJSON(results.data || []);
      const badge = document.getElementById('badge');
      badge.textContent = `Точек: ${geojson.features.length}`;

      function addLayers(){
        if (map.getSource('brews')) {
          map.getSource('brews').setData(geojson);
          fitToData(geojson); return;
        }
        map.addSource('brews', { type:'geojson', data:geojson, cluster:true, clusterMaxZoom:14, clusterRadius:50 });

        map.addLayer({
          id:'clusters', type:'circle', source:'brews', filter:['has','point_count'],
          paint:{
            'circle-color': ['step',['get','point_count'],'#9ecae1',10,'#6baed6',30,'#3182bd'],
            'circle-radius': ['step',['get','point_count'],16,10,20,30,26]
          }
        });
        map.addLayer({
          id:'cluster-count', type:'symbol', source:'brews', filter:['has','point_count'],
          layout:{ 'text-field': ['get','point_count_abbreviated'], 'text-size':12 },
          paint:{ 'text-color':'#08306b' }
        });
        map.addLayer({
          id:'unclustered', type:'circle', source:'brews', filter:['!', ['has','point_count']],
          paint:{
            'circle-color':'#e6550d','circle-radius':6,'circle-stroke-width':1,'circle-stroke-color':'#fff'
          }
        });

        map.on('click','clusters',(e)=>{
          const f = map.queryRenderedFeatures(e.point,{layers:['clusters']})[0];
          map.getSource('brews').getClusterExpansionZoom(f.properties.cluster_id,(err,zoom)=>{
            if (!err) map.easeTo({center:f.geometry.coordinates, zoom});
          });
        });
        map.on('click','unclustered',(e)=>{
          const f = e.features[0];
          new mapboxgl.Popup({ offset:12, maxWidth:'360px' })
            .setLngLat(f.geometry.coordinates)
            .setHTML(popupHTML(f.properties))
            .addTo(map);
        });

        map.on('mouseenter','clusters',()=>map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','clusters',()=>map.getCanvas().style.cursor='');
        map.on('mouseenter','unclustered',()=>map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','unclustered',()=>map.getCanvas().style.cursor='');

        fitToData(geojson);
      }

      if (map.isStyleLoaded && map.isStyleLoaded()) addLayers();
      else map.on('load', addLayers);
    },
    error: (err) => {
      document.getElementById('badge').textContent = 'Ошибка загрузки CSV';
      console.error('CSV error:', err);
    }
  });

  // Заголовок в «glass»-чипе
  document.getElementById('collectionTitle').textContent = 'My coffee experience';
</script>
</body>
</html>
