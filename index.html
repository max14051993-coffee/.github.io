<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coffee Log — Map</title>

  <!-- Mapbox + PapaParse -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body,#map{height:100%;margin:0}
    .badge{position:absolute;top:8px;left:8px;background:#fff;padding:6px 10px;border-radius:8px;font:14px/1.2 system-ui;box-shadow:0 2px 10px rgba(0,0,0,.06);z-index:5}
    :root{
      --card-bg: rgba(255,255,255,.86); --card-border: rgba(0,0,0,.06);
      --title: #0f1b10; --pill-bg: rgba(84,116,75,.12); --pill-br: rgba(84,116,75,.28);
      --glass: rgba(255,255,255,.9); --glass-br: rgba(0,0,0,.08); --text: #0f1b10;
    }
    body[data-theme="dark"]{
      --card-bg: rgba(22,24,27,.85); --card-border: rgba(255,255,255,.12);
      --title: #f3f5f1; --pill-bg: rgba(160,200,160,.14); --pill-br: rgba(190,230,190,.30);
      --glass: rgba(22,24,27,.9); --glass-br: rgba(255,255,255,.12); --text: #f3f5f1;
    }
    .mapboxgl-popup-content{ background:transparent; padding:0; border-radius:20px; box-shadow:none }
    .mapboxgl-popup-tip{ display:none }
    .popup-card{ width:320px; max-width:90vw; border-radius:20px; overflow:hidden;
      background:var(--card-bg); border:1px solid var(--card-border); font:14px/1.35 system-ui }
    .popup-cover{ display:block; width:100%; height:200px; object-fit:cover }
    .popup-body{ padding:14px }
    .popup-title{ font-weight:800; font-size:18px; margin:2px 0 6px; color:var(--title) }
    .process-pill{ font-size:12px; padding:5px 10px; border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-br); color:var(--title); margin-left:auto }
    .collection-title{
      position:absolute; top:12px; left:50%; transform:translateX(-50%);
      background:var(--glass); color:var(--text); padding:8px 14px; border-radius:12px; border:1px solid var(--glass-br);
      z-index:5; white-space:nowrap; max-width:80vw; overflow:hidden; text-overflow:ellipsis; font:600 16px/1.2 system-ui
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="badge" id="badge">Загружаю данные…</div>
  <div class="collection-title" id="collectionTitle">Coffee Log</div>

<script>
  // ==== ЗАПОЛНИ ЭТИ 2 ПАРАМЕТРА ====
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibWF4MTQwNTE5OTMtY29mZmVlIiwiYSI6ImNtZTVic3c3dTBxZDMya3F6MzV0ejY1YjcifQ._YoZjruPVrVHtusEf8OkZw';
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5ft53W2ettUoEJqOyaJFoySOEbGr14qomprmDRlCwI0F3WEhnTn6IybbqgP_q9yv23sfNeqlPN5x/pub?output=csv';

  // Тема из URL: ?style=dark  |  ?style=light (по умолчанию — light)
  const theme = (new URLSearchParams(location.search).get('style') || 'light').toLowerCase();
  document.body.dataset.theme = theme;

  // Сопоставление заголовков из таблицы
  const HEADERS = {
    timestamp: ['Timestamp','created_at'],
    uploader: ['Uploader'],
    originCountry: ['Origin country','country'],
    originRegion: ['Origin region','region'],
    farmName: ['Farm name','farm_name'],
    process: ['Process','process'],
    brewMethod: ['Brew method','brew_method'],
    whereConsumed: ['Where consumed','where_consumed'],
    cafeName: ['Cafe name','Cafe name (if "кофейня")','cafe_name'],
    recipe: ['Recipe','recipe'],
    roasterName: ['Roaster name','roaster_name'],
    roasterCity: ['Roaster city','roaster_city'],
    photoUrl: ['Photo (URL)','photo_url'],
    lat: ['Latitude (lat)','lat','Latitude'],
    lng: ['Longitude (lng)','lng','Longitude']
  };

  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [12, 20],
    zoom: 2.2,
    attributionControl: true
  });
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  // 3D-террейн/небо/туман как в твоём примере
  map.on('load', () => {
    if (!map.getSource('terrain-dem')) {
      map.addSource('terrain-dem', { type: 'raster-dem', url: 'mapbox://mapbox.terrain-rgb', tileSize: 512 });
    }
    map.setTerrain({ source: 'terrain-dem', exaggeration: 1.6 });
    if (!map.getLayer('sky')) {
      map.addLayer({ id: 'sky', type: 'sky', paint: { 'sky-type':'atmosphere', 'sky-atmosphere-sun':[10,25], 'sky-atmosphere-sun-intensity': 10 } });
    }
    map.setFog({ range:[0.6, 12], color:'#f6efe7', 'high-color':'#d4c7b8', 'horizon-blend':0.2, 'star-intensity':0 });
  });

  // Утилиты
  function pick(obj, keys) { for (const k of keys) if (obj[k] !== undefined && obj[k] !== '') return obj[k]; return ''; }
  function toNumber(v){ if (typeof v==='number') return v; if (typeof v==='string') return parseFloat(v.replace(',', '.')); return NaN; }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }

  function rowsToGeoJSON(rows) {
    const features = [];
    for (const row of rows) {
      const lat = toNumber(pick(row, HEADERS.lat));
      const lng = toNumber(pick(row, HEADERS.lng));
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      features.push({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [lng, lat] },
        properties: {
          timestamp: pick(row, HEADERS.timestamp),
          uploader: pick(row, HEADERS.uploader),
          originCountry: pick(row, HEADERS.originCountry),
          originRegion: pick(row, HEADERS.originRegion),
          farmName: pick(row, HEADERS.farmName),
          process: pick(row, HEADERS.process),
          brewMethod: pick(row, HEADERS.brewMethod),
          whereConsumed: pick(row, HEADERS.whereConsumed),
          cafeName: pick(row, HEADERS.cafeName),
          recipe: pick(row, HEADERS.recipe),
          roasterName: pick(row, HEADERS.roasterName),
          roasterCity: pick(row, HEADERS.roasterCity),
          photoUrl: pick(row, HEADERS.photoUrl)
        }
      });
    }
    return { type: 'FeatureCollection', features };
  }

  function flagEmoji(countryName){
  if(!countryName) return '';
  const m = {
    // Африка
    'Ethiopia':'ET','Kenya':'KE','Rwanda':'RW','Burundi':'BI','Tanzania':'TZ','Uganda':'UG',
    'Democratic Republic of the Congo':'CD','Zambia':'ZM','Zimbabwe':'ZW','Malawi':'MW',
    // Америка
    'Brazil':'BR','Colombia':'CO','Peru':'PE','Bolivia':'BO','Ecuador':'EC','Venezuela':'VE',
    'Panama':'PA','Costa Rica':'CR','Guatemala':'GT','Honduras':'HN','El Salvador':'SV',
    'Nicaragua':'NI','Mexico':'MX','Dominican Republic':'DO','Jamaica':'JM','Haiti':'HT','Hawaii (USA)':'US',
    // Азия/ME
    'Yemen':'YE','Saudi Arabia':'SA','India':'IN','Indonesia':'ID','East Timor (Timor-Leste)':'TL',
    'Papua New Guinea':'PG','China (Yunnan)':'CN','Thailand':'TH','Vietnam':'VN','Myanmar':'MM',
    'Philippines':'PH','Laos':'LA','Nepal':'NP','Sri Lanka':'LK',
    // Океания
    'Solomon Islands':'SB'
  };
  const clean = countryName.replace(/\s*\(.*?\)\s*/,'');
  const code = m[countryName] || m[clean];
  if(!code) return '';
  return [...code.toUpperCase()].map(c => String.fromCodePoint(0x1F1E6 + c.charCodeAt(0)-65)).join('');
}


  function fitToData(geojson){
    if (!geojson.features.length) return;
    const b = new mapboxgl.LngLatBounds();
    geojson.features.forEach(f => b.extend(f.geometry.coordinates));
    map.fitBounds(b, { padding: 40, duration: 700, maxZoom: 10 });
  }

  // Карточка в стиле твоего шаблона
  function popupHTML(p) {
    const flag = flagEmoji(p.originCountry || '');
    const country = (flag ? flag + ' ' : '') + escapeHtml(p.originCountry || '');
    const region  = escapeHtml(p.originRegion || '');
    const place   = [country, region].filter(Boolean).join(', ');
    const roaster = (p.roasterName ? escapeHtml(p.roasterName) : '') +
                    (p.roasterCity ? ' (' + escapeHtml(p.roasterCity) + ')' : '');
    const process = p.process ? `<span class="process-pill">${escapeHtml(p.process)}</span>` : '';
    const photo   = p.photoUrl
      ? `<img class="popup-cover" src="${escapeAttr(p.photoUrl)}" alt="photo">`
      : `<div class="popup-cover" style="height:140px;background:linear-gradient(180deg,#e7efe1,#f4f7f1)"></div>`;

    const rows = [];
    if (p.process)     rows.push(row('Process', p.process));
    if (p.brewMethod)  rows.push(row('Method',  p.brewMethod));
    if (p.whereConsumed) rows.push(row('Where', p.whereConsumed + (p.cafeName ? ' — ' + p.cafeName : '')));
    if (p.recipe)      rows.push(row('Recipe',  p.recipe));
    if (roaster)       rows.push(row('Roaster', roaster));
    if (p.uploader)    rows.push(row('By',      p.uploader));

    return `
      <div class="popup-card">
        ${photo}
        <div class="popup-body">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <div class="popup-title" style="flex:1">${escapeHtml(p.farmName || 'Без названия')}</div>
            ${process}
          </div>
          <div class="popup-meta" style="margin-bottom:6px;color:#555">${place || '—'}</div>
          ${rows.join('')}
        </div>
      </div>
    `;

    function row(label, val){
      return `<div style="margin:2px 0"><span style="color:#666">${escapeHtml(label)}: </span>${escapeHtml(val||'')}</div>`;
    }
  }

  // Загрузка CSV → добавление слоёв
  Papa.parse(CSV_URL, {
    download: true, header: true, dynamicTyping: false,
    complete: (results) => {
      const geojson = rowsToGeoJSON(results.data || []);
      const badge = document.getElementById('badge');
      badge.textContent = `Точек: ${geojson.features.length}`;

      function addLayers(){
        if (map.getSource('brews')) {
          map.getSource('brews').setData(geojson);
          fitToData(geojson); return;
        }
        map.addSource('brews', { type:'geojson', data:geojson, cluster:true, clusterMaxZoom:14, clusterRadius:50 });

        map.addLayer({
          id:'clusters', type:'circle', source:'brews', filter:['has','point_count'],
          paint:{
            'circle-color': ['step',['get','point_count'],'#9ecae1',10,'#6baed6',30,'#3182bd'],
            'circle-radius': ['step',['get','point_count'],16,10,20,30,26]
          }
        });
        map.addLayer({
          id:'cluster-count', type:'symbol', source:'brews', filter:['has','point_count'],
          layout:{ 'text-field': ['get','point_count_abbreviated'], 'text-size':12 },
          paint:{ 'text-color':'#08306b' }
        });
        map.addLayer({
          id:'unclustered', type:'circle', source:'brews', filter:['!', ['has','point_count']],
          paint:{
            'circle-color':'#e6550d','circle-radius':6,'circle-stroke-width':1,'circle-stroke-color':'#fff'
          }
        });

        map.on('click','clusters',(e)=>{
          const f = map.queryRenderedFeatures(e.point,{layers:['clusters']})[0];
          map.getSource('brews').getClusterExpansionZoom(f.properties.cluster_id,(err,zoom)=>{
            if (!err) map.easeTo({center:f.geometry.coordinates, zoom});
          });
        });
        map.on('click','unclustered',(e)=>{
          const f = e.features[0];
          new mapboxgl.Popup({ offset:12, maxWidth:'360px' })
            .setLngLat(f.geometry.coordinates)
            .setHTML(popupHTML(f.properties))
            .addTo(map);
        });

        map.on('mouseenter','clusters',()=>map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','clusters',()=>map.getCanvas().style.cursor='');
        map.on('mouseenter','unclustered',()=>map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','unclustered',()=>map.getCanvas().style.cursor='');

        fitToData(geojson);
      }

      if (map.isStyleLoaded && map.isStyleLoaded()) addLayers();
      else map.on('load', addLayers);
    },
    error: (err) => {
      document.getElementById('badge').textContent = 'Ошибка загрузки CSV';
      console.error('CSV error:', err);
    }
  });

  // Заголовок в «glass»-чипе
  document.getElementById('collectionTitle').textContent = 'Коллекция кофейного опыта';
</script>
</body>
</html>
