<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coffee Log Map</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height:100%; margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { position:fixed; inset:0; }
    .badge {
      position: fixed; top: 10px; left: 10px; z-index: 10;
      background:#fff; padding:8px 12px; border-radius:10px;
      box-shadow:0 4px 14px rgba(0,0,0,.08); max-width: 560px;
    }
    .popup {
      font: 13px/1.4 system-ui; max-width: 320px;
    }
    .popup .title { font-weight:600; margin-bottom:4px; }
    .popup .sub { color:#555; margin-bottom:6px; }
    .popup img { width:100%; height:auto; border-radius:10px; display:block; margin:8px 0; }
    .popup .row { margin:2px 0; }
    .popup .label { color:#666; }
    .link { color:#0b6cfb; text-decoration:none; }
  </style>
</head>
<body>
  <div class="badge">
    <div><b>Coffee Log</b> — карта твоих записей из Google Sheets</div>
    <div style="font-size:12px;color:#555;">Кластеры = группы точек; кликни по кружку, чтобы приблизиться. Клик по точке — откроет карточку.</div>
  </div>
  <div id="map"></div>

  <script>
    // === ЗАМЕНИ ЭТИ ДВА ЗНАЧЕНИЯ ===
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibWF4MTQwNTE5OTMtY29mZmVlIiwiYSI6ImNtZTVic3c3dTBxZDMya3F6MzV0ejY1YjcifQ._YoZjruPVrVHtusEf8OkZw'; // твой Mapbox Access Token
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5ft53W2ettUoEJqOyaJFoySOEbGr14qomprmDRlCwI0F3WEhnTn6IybbqgP_q9yv23sfNeqlPN5x/pub?output=csv'; // опубликованная CSV-ссылка

    // (опционально) стиль карты
    const MAP_STYLE = 'mapbox://styles/mapbox/light-v11';

    // Заголовки, которые ожидаем из формы/таблицы
    const HEADERS = {
      timestamp: ['Timestamp','created_at'],
      uploader: ['Uploader'],
      originCountry: ['Origin country','country'],
      originRegion: ['Origin region','region'],
      farmName: ['Farm name','farm_name'],
      process: ['Process','process'],
      brewMethod: ['Brew method','brew_method'],
      whereConsumed: ['Where consumed','where_consumed'],
      cafeName: ['Cafe name','Cafe name (if "кофейня")','cafe_name'],
      recipe: ['Recipe','recipe'],
      roasterName: ['Roaster name','roaster_name'],
      roasterCity: ['Roaster city','roaster_city'],
      photoUrl: ['Photo (URL)','photo_url'],
      lat: ['Latitude (lat)','lat','Latitude'],
      lng: ['Longitude (lng)','lng','Longitude']
    };

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: MAP_STYLE,
      center: [12, 20], // стартовый вид (Африка/Европа/Ближний Восток)
      zoom: 2.2
    });
    map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

    // Утилита: взять поле по нескольким возможным заголовкам
    function pick(obj, keys) {
      for (const k of keys) {
        if (obj[k] !== undefined && obj[k] !== '') return obj[k];
      }
      return '';
    }

    function toNumber(v) {
      if (typeof v === 'number') return v;
      if (typeof v === 'string') return parseFloat(v.replace(',', '.'));
      return NaN;
    }

    function rowsToGeoJSON(rows) {
      const features = [];
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];

        const lat = toNumber(pick(row, HEADERS.lat));
        const lng = toNumber(pick(row, HEADERS.lng));
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

        const props = {
          timestamp: pick(row, HEADERS.timestamp),
          uploader: pick(row, HEADERS.uploader),
          originCountry: pick(row, HEADERS.originCountry),
          originRegion: pick(row, HEADERS.originRegion),
          farmName: pick(row, HEADERS.farmName),
          process: pick(row, HEADERS.process),
          brewMethod: pick(row, HEADERS.brewMethod),
          whereConsumed: pick(row, HEADERS.whereConsumed),
          cafeName: pick(row, HEADERS.cafeName),
          recipe: pick(row, HEADERS.recipe),
          roasterName: pick(row, HEADERS.roasterName),
          roasterCity: pick(row, HEADERS.roasterCity),
          photoUrl: pick(row, HEADERS.photoUrl)
        };

        features.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [lng, lat] },
          properties: props
        });
      }
      return { type: 'FeatureCollection', features };
    }

    function fitToData(geojson) {
      if (!geojson.features.length) return;
      const bounds = new mapboxgl.LngLatBounds();
      geojson.features.forEach(f => bounds.extend(f.geometry.coordinates));
      map.fitBounds(bounds, { padding: 40, duration: 700, maxZoom: 10 });
    }

    function popupHTML(p) {
      const lines = [];
      lines.push(`<div class="title">${escapeHtml(p.farmName || 'Unknown farm')}</div>`);
      lines.push(`<div class="sub">${escapeHtml(p.originCountry)}${p.originRegion ? ', ' + escapeHtml(p.originRegion) : ''}</div>`);
      if (p.photoUrl) lines.push(`<img src="${escapeAttr(p.photoUrl)}" alt="photo">`);
      lines.push(row('Process', p.process));
      lines.push(row('Method', p.brewMethod));
      lines.push(row('Where', p.whereConsumed + (p.cafeName ? ' — ' + p.cafeName : '')));
      lines.push(row('Recipe', p.recipe));
      lines.push(row('Roaster', (p.roasterName || '') + (p.roasterCity ? ' (' + escapeHtml(p.roasterCity) + ')' : '')));
      lines.push(row('By', p.uploader));
      lines.push(row('When', p.timestamp));
      return `<div class="popup">${lines.join('')}</div>`;

      function row(label, val) {
        if (!val) return '';
        return `<div class="row"><span class="label">${escapeHtml(label)}: </span>${linkify(escapeHtml(val))}</div>`;
      }
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr(s) { return String(s || '').replace(/"/g, '&quot;'); }
    function linkify(s) {
      // простая замена URL на ссылки
      return s.replace(/(https?:\/\/[^\s]+)/g, '<a class="link" target="_blank" rel="noopener" href="$1">$1</a>');
    }

    // 1) Загружаем CSV, 2) строим GeoJSON, 3) добавляем источник/слои
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  dynamicTyping: false,
  complete: (results) => {
    const geojson = rowsToGeoJSON(results.data || []);
    console.log('CSV rows:', (results.data || []).length, 'Features:', geojson.features.length);

    function addLayers() {
      // если уже добавляли — просто обновим данные
      if (map.getSource && map.getSource('brews')) {
        map.getSource('brews').setData(geojson);
        fitToData(geojson);
        return;
      }

      map.addSource('brews', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'brews',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': [
            'step', ['get', 'point_count'],
            '#9ecae1', 10,
            '#6baed6', 30,
            '#3182bd'
          ],
          'circle-radius': [
            'step', ['get', 'point_count'],
            16, 10,
            20, 30,
            26
          ]
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'brews',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-size': 12
        },
        paint: { 'text-color': '#08306b' }
      });

      map.addLayer({
        id: 'unclustered',
        type: 'circle',
        source: 'brews',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': '#e6550d',
          'circle-radius': 6,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#fff'
        }
      });

      // клики
      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const cid = features[0].properties.cluster_id;
        map.getSource('brews').getClusterExpansionZoom(cid, (err, zoom) => {
          if (!err) map.easeTo({ center: features[0].geometry.coordinates, zoom });
        });
      });

      map.on('click', 'unclustered', (e) => {
        const f = e.features[0];
        new mapboxgl.Popup({ offset: 12 })
          .setLngLat(f.geometry.coordinates)
          .setHTML(popupHTML(f.properties))
          .addTo(map);
      });

      fitToData(geojson);
    }

    // ВАЖНО: если стиль уже загружен — добавляем сразу, иначе ждём событие
    if (map.isStyleLoaded && map.isStyleLoaded()) addLayers();
    else map.on('load', addLayers);
  },
  error: (err) => {
    alert('CSV load error: ' + err);
    console.error(err);
  }
});
</script>

</body>
</html>
