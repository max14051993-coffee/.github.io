<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Coffee Log ‚Äî Map</title>

  <!-- Mapbox + PapaParse -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body,#map{height:100%;margin:0}
    html,body{
      font:14px/1.35 system-ui,-apple-system,"Segoe UI",Roboto,Arial,
            "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji";
      -webkit-tap-highlight-color: transparent;
    }

    :root{
      --card-bg: rgba(255,255,255,.86); --card-border: rgba(0,0,0,.06);
      --title: #0f1b10; --pill-bg: rgba(84,116,75,.12); --pill-br: rgba(84,116,75,.28);
      --glass: rgba(255,255,255,.9); --glass-br: rgba(0,0,0,.08); --text: #0f1b10;
      --muted: #5b5f5b;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }
    body[data-theme="dark"]{
      --card-bg: rgba(22,24,27,.85); --card-border: rgba(255,255,255,.12);
      --title: #f3f5f1; --pill-bg: rgba(160,200,160,.14); --pill-br: rgba(190,230,190,.30);
      --glass: rgba(22,24,27,.9); --glass-br: rgba(255,255,255,.12); --text: #f3f5f1;
      --muted: #c9cdc8;
    }

    .collection-title{
      position:absolute; top:12px; left:50%; transform:translateX(-50%);
      background:var(--glass); color:var(--text); padding:8px 14px; border-radius:12px; border:1px solid var(--glass-br);
      z-index:6; max-width:80vw; overflow:hidden; text-overflow:ellipsis; font:600 16px/1.2 system-ui;
      white-space:nowrap;
    }

    .badge{
      position:absolute; z-index:9999; top:12px; left:12px;
      background:var(--glass);border:1px solid var(--glass-br);color:var(--text);
      border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);
      font:13px/1.2 system-ui;backdrop-filter: blur(4px);
    }
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--glass-br)}
    label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    input[type="checkbox"]{width:18px;height:18px;accent-color:#567a58}

    .desktop-controls{ display:block; padding:8px 10px; }
    .desktop-controls .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .desktop-controls .row + .row{margin-top:6px}
    #filtersDetails{display:none}

    .achievements{
      position:absolute;top:12px;right:12px;z-index:10000;
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;max-width:46vw;
    }
    .ach-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--glass-br);font:12px/1.1 system-ui;box-shadow:0 2px 10px rgba(0,0,0,.06); white-space:nowrap;}
    .ach-emoji{font-size:14px}
    .ach-title{font-weight:600}

    .mapboxgl-popup-content{ background:transparent; padding:0; border-radius:20px; box-shadow:none }
    .mapboxgl-popup-tip{ display:none }
    .popup-card{
      position:relative; width:320px; max-width:92vw; border-radius:20px; overflow:hidden;
      background:var(--card-bg); border:1px solid var(--card-border); font:14px/1.35 system-ui
    }
    .popup-cover-box{ width:100%; height:200px; background:linear-gradient(180deg,#e7efe1,#f4f7f1) }
    .popup-cover{ width:100%; height:100%; object-fit:cover; display:block }
    .popup-body{ padding:14px }
    .popup-title{ font-weight:800; font-size:18px; margin:2px 0 6px; color:var(--title) }
    .row{margin:2px 0; display:flex; align-items:baseline; gap:8px}
    .row-emoji{width:1.2em; text-align:center}
    .meta{margin-bottom:6px;color:var(--muted)}
    .process-badge{
      position:absolute; top:10px; right:10px; z-index:2;
      font-size:12px; padding:6px 12px; border-radius:999px;
      border:1px solid transparent; background:rgba(255,255,255,.85);
      backdrop-filter: blur(2px);
    }

    @media (max-width:1024px){
      .collection-title{ max-width:70vw; }
      .popup-card{ width:360px; }
      .popup-cover-box{ height:220px; }
    }
    @media (max-width:680px){
      .collection-title{top:calc(8px + var(--safe-top));font-size:15px;max-width:72vw}

      .achievements{
        top:auto; bottom:calc(12px + var(--safe-bottom));
        right:calc(12px + var(--safe-right));
        left:auto;
        flex-wrap:wrap; overflow-x:visible; max-width:68vw;
        justify-content:flex-end;
      }

      .badge{
        top:auto; left:calc(12px + var(--safe-left));
        bottom:calc(12px + var(--safe-bottom));
        right:auto; padding:0; max-width:min(88vw, 420px);
      }
      .desktop-controls{display:none}
      #filtersDetails{display:block}
      #filtersDetails summary{
        padding:10px 12px;background:var(--glass);border-radius:14px;border:1px solid var(--glass-br);
        display:flex;align-items:center;gap:8px;cursor:pointer
      }
      #filtersDetails .panel{padding:10px 12px;border-top:1px solid var(--glass-br)}

      .mapboxgl-ctrl-bottom-right{bottom:calc(56px + var(--safe-bottom)) !important}
      .popup-card{ width:min(96vw, 520px); }
      .popup-cover-box{ height: 34vh; min-height: 160px; }
      .popup-title{ font-size:17px; }
      .process-badge{ font-size:12px; padding:6px 10px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="collection-title" id="collectionTitle">My coffee experience</div>

  <div class="badge" id="badge">
    <div class="desktop-controls" id="desktopControls"></div>
    <details id="filtersDetails">
      <summary>‚òï –ü–∞–Ω–µ–ª—å</summary>
      <div class="panel" id="mobileControls"></div>
    </details>
  </div>

  <div class="achievements" id="achievements"></div>

<script>
  /* ==== –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==== */
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibWF4MTQwNTE5OTMtY29mZmVlIiwiYSI6ImNtZTVic3c3dTBxZDMya3F6MzV0ejY1YjcifQ._YoZjruPVrVHtusEf8OkZw';
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSbms6-9Pie6VdyXzbjiMwWeIF-mxMvMiyFHaRI1DJE0nPNkSG99lewaeeU8YIuj7Y8vxzJGOD2md1v/pub?gid=1055803810&single=true&output=csv';

  const theme = (new URLSearchParams(location.search).get('style') || 'light').toLowerCase();
  document.body.dataset.theme = theme;
  const FLAG_MODE = (new URLSearchParams(location.search).get('flag') || 'img').toLowerCase(); // 'img' | 'emoji'

  /* ==== –∫–∞—Ä—Ç–∞ ==== */
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: theme === 'dark' ? 'mapbox://styles/mapbox/dark-v11' : 'mapbox://styles/mapbox/light-v11',
    center: [12, 20], zoom: 2.2, attributionControl: true, renderWorldCopies: false
  });
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
  map.doubleClickZoom.disable();

  map.on('load', () => {
    if (!map.getSource('terrain-dem')) {
      map.addSource('terrain-dem', { type: 'raster-dem', url: 'mapbox://mapbox.terrain-rgb', tileSize: 512 });
    }
    map.setTerrain({ source: 'terrain-dem', exaggeration: 1.6 });
    if (!map.getLayer('sky')) {
      map.addLayer({ id: 'sky', type: 'sky', paint: { 'sky-type':'atmosphere', 'sky-atmosphere-sun':[10,25], 'sky-atmosphere-sun-intensity': 10 } });
    }
    map.setFog({ range:[0.6, 12], color:'#f6efe7', 'high-color':'#d4c7b8', 'horizon-blend':0.2, 'star-intensity':0 });
  });

  /* ==== —É—Ç–∏–ª–∏—Ç—ã ==== */
  const normKey = (k) => String(k||'').toLowerCase().replace(/\s+/g,' ').trim();
  const normalizeName = (s) => String(s||'').replace(/\s+/g,' ').trim();
  const toNumber = (v) => (typeof v==='number') ? v : (typeof v==='string' ? parseFloat(v.replace(',', '.')) : NaN);
  const escapeHtml = (s) => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])[m]);
  const escapeAttr = (s) => String(s||'').replace(/"/g,'&quot;');

  function pickSmart(row, candidates){
    for (const k of candidates) if (row[k] !== undefined && row[k] !== '') return row[k];
    const nRow = {}; for (const key in row) nRow[normKey(key)] = row[key];
    for (const cand of candidates){ const nCand = normKey(cand); if (nRow[nCand] !== undefined && nRow[nCand] !== '') return nRow[nCand]; }
    const allKeys = Object.keys(row);
    for (const cand of candidates){
      const nCand = normKey(cand);
      for (const key of allKeys){
        if (normKey(key).startsWith(nCand) && row[key] !== '') return row[key];
      }
    }
    return '';
  }

  function normalizeProcessName(raw){
    const s = String(raw||'').toLowerCase();
    if (!s) return 'other';
    if (/(honey|red honey|yellow honey|white honey|black honey)/.test(s)) return 'honey';
    if (/(anaer|carbonic|cm|—Ç–µ—Ä–º–æ|thermal|macerat|carbonique)/.test(s)) return 'anaerobic';
    if (/(wash|fully washed|wet|–º—ã—Ç–∞|–º—ã—Ç—ã–π|–≤—ã–º—ã—Ç)/.test(s)) return 'washed';
    if (/(natur|dry|—Å—É—Ö)/.test(s)) return 'natural';
    if (/(yeast|–∫–æ—ò–∏|koji|enzym|—Ñ–µ—Ä–º–µ–Ω—Ç|co-?ferment|double|triple|wine)/.test(s)) return 'experimental';
    return 'other';
  }
  function processColors(pType){
    switch(pType){
      case 'washed':      return { point:'#2e7d32', bg:'#d7f0df', br:'#82b998', txt:'#205b3a' };
      case 'natural':     return { point:'#c0392b', bg:'#ffd9d2', br:'#e59883', txt:'#7a1d12' };
      case 'honey':       return { point:'#c77f0a', bg:'#ffe9c6', br:'#e9b86a', txt:'#6b4800' };
      case 'anaerobic':   return { point:'#6a3cbc', bg:'#e6d7ff', br:'#b79de5', txt:'#3b2b6f' };
      case 'experimental':return { point:'#2c5aa0', bg:'#dde9f7', br:'#9bb9e6', txt:'#1f3a63' };
      default:            return { point:'#777777', bg:'#eeeeee', br:'#cccccc', txt:'#333333' };
    }
  }

  function extractDriveId(url){
    const m = String(url||'').match(/(?:\/d\/|id=)([-\w]{25,})/);
    return m ? m[1] : null;
  }
  function driveImgHtml(url){
    if (!url) return '';
    if (/thumbnail\?id=/.test(url)) return `<img class="popup-cover" loading="lazy" src="${escapeAttr(url)}" alt="photo">`;
    const id = extractDriveId(url);
    const chain = id ? [
      `https://drive.google.com/thumbnail?id=${id}&sz=w1600`,
      `https://lh3.googleusercontent.com/d/${id}=w1600`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ] : [url];
    const first = chain.shift();
    return `<img class="popup-cover" loading="lazy" src="${escapeAttr(first)}"
             alt="photo" onerror="driveImgFallback(this, ${JSON.stringify(chain)})">`;
  }
  function driveImgFallback(img, list){ if (!list || !list.length) { img.remove(); return; } img.src = list.shift(); }
  window.driveImgFallback = driveImgFallback;

  function flagFromRow(flagEmojiCell, iso2Cell){
    const emoji = String(flagEmojiCell||'').trim();
    if (FLAG_MODE==='emoji' && emoji) return emoji;
    const code = String(iso2Cell||'').trim().toLowerCase();
    return (code.length===2)
      ? `<img src="https://flagcdn.com/24x18/${code}.png" alt="${code.toUpperCase()}" width="24" height="18" style="vertical-align:-2px;border-radius:2px">`
      : (FLAG_MODE==='emoji' ? emoji : '');
  }

  /* ==== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤ ==== */
  let CITY_COORDS = {}; // —Å—é–¥–∞ –∑–∞–ø–∏—à–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–æ–≤ –ø–æ—Å–ª–µ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞

  /* ==== –∑–∞–≥–æ–ª–æ–≤–∫–∏ CSV ==== */
  const HEADERS = {
    timestamp:       ['Timestamp'],
    email:           ['Email Address'],
    uploader:        ['Uploader'],
    originCountry:   ['Origin country'],
    originRegion:    ['Origin region'],
    farmName:        ['Farm name'],
    process:         ['Process'],
    brewMethod:      ['Brew method'],
    whereConsumed:   ['Where consumed'],
    cafeName:        ['Cafe name'],
    cafeUrl:         ['Cafe URL'],
    consumedCity:    ['Consumed city','Consumed city '],
    consumedAddr:    ['Consumed address'],
    recipe:          ['Recipe'],
    roasterName:     ['Roaster name'],
    roasterCity:     ['Roaster city'],
    fileUpload:      ['File upload','File upload '],
    lat:             ['Latitude (lat)','Latitude'],
    lng:             ['Longitude (lng)','Longitude'],
    photoUrl:        ['Photo (URL)'],
    geocodeSource:   ['Geocode source'],
    geocodeAccuracy: ['Geocode accuracy'],
    matchedName:     ['Matched name'],
    countryIso2:     ['Country ISO2'],
    flagEmoji:       ['Flag emoji']
  };

  function rowsToGeoJSON(rows) {
    const features = [];
    for (const row of rows) {
      const lat = toNumber(pickSmart(row, HEADERS.lat));
      const lng = toNumber(pickSmart(row, HEADERS.lng));
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      let photo = pickSmart(row, HEADERS.photoUrl);
      if (!photo) photo = pickSmart(row, HEADERS.fileUpload);

      const processRaw  = pickSmart(row, HEADERS.process);
      const processNorm = normalizeProcessName(processRaw);

      const p = {
        timestamp:       pickSmart(row, HEADERS.timestamp),
        email:           pickSmart(row, HEADERS.email),
        uploader:        pickSmart(row, HEADERS.uploader),
        originCountry:   pickSmart(row, HEADERS.originCountry),
        originRegion:    pickSmart(row, HEADERS.originRegion),
        farmName:        pickSmart(row, HEADERS.farmName),
        process:         processRaw,
        process_norm:    processNorm,
        brewMethod:      pickSmart(row, HEADERS.brewMethod),
        whereConsumed:   pickSmart(row, HEADERS.whereConsumed),
        cafeName:        pickSmart(row, HEADERS.cafeName),
        cafeUrl:         pickSmart(row, HEADERS.cafeUrl),
        consumedCity:    pickSmart(row, HEADERS.consumedCity),
        consumedAddr:    pickSmart(row, HEADERS.consumedAddr),
        recipe:          pickSmart(row, HEADERS.recipe),
        roasterName:     pickSmart(row, HEADERS.roasterName),
        roasterCity:     pickSmart(row, HEADERS.roasterCity),
        photoUrl:        photo,
        matchedName:     pickSmart(row, HEADERS.matchedName),
        countryIso2:     pickSmart(row, HEADERS.countryIso2),
        flagEmoji:       pickSmart(row, HEADERS.flagEmoji)
      };

      features.push({ type:'Feature', geometry:{ type:'Point', coordinates:[lng,lat] }, properties:p });
    }
    return { type:'FeatureCollection', features };
  }

  function fitToData(geojson){
    if (!geojson.features.length) return;
    const b = new mapboxgl.LngLatBounds();
    geojson.features.forEach(f => b.extend(f.geometry.coordinates));
    map.fitBounds(b, { padding: 40, duration: 700, maxZoom: 10 });
  }

  function popupHTML(p) {
    const flag = flagFromRow(p.flagEmoji, p.countryIso2);
    const country = p.originCountry ? ((flag ? flag + ' ' : '') + escapeHtml(p.originCountry)) : '';
    const region  = escapeHtml(p.originRegion || '');
    const place   = [country, region].filter(Boolean).join(', ');
    const roaster = (p.roasterName ? escapeHtml(p.roasterName) : '') +
                    (p.roasterCity ? ' (' + escapeHtml(p.roasterCity) + ')' : '');
    const photo = `<div class="popup-cover-box">${ p.photoUrl ? driveImgHtml(p.photoUrl) : '' }</div>`;

    const rows = [];
    if (p.brewMethod) rows.push(emojiRow('üßâ','Method', escapeHtml(p.brewMethod)));

    if (p.whereConsumed || p.consumedCity || p.consumedAddr || p.cafeUrl) {
      const bits = [];
      if (p.whereConsumed) bits.push(escapeHtml(p.whereConsumed));
      if (p.consumedCity)  bits.push(escapeHtml(p.consumedCity));
      let whereHtml = bits.join(' ‚Äî ');
      if (p.cafeUrl) whereHtml += ` <a href="${escapeAttr(p.cafeUrl)}" target="_blank" rel="noopener" title="–°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–≤–µ–¥–µ–Ω–∏–µ">üîó</a>`;
      rows.push(emojiRow('üìç','Where', whereHtml));
      if (p.consumedAddr) rows.push(`<div class="row" style="margin-left:1.6em;color:#666">${escapeHtml(p.consumedAddr)}</div>`);
    }

    if (p.recipe)   rows.push(emojiRow('üìã','Recipe', escapeHtml(p.recipe)));
    if (roaster)    rows.push(emojiRow('üè≠','Roaster', roaster));
    if (p.uploader) rows.push(emojiRow('üë§','By', escapeHtml(p.uploader)));

    const pType = p.process_norm || 'other';
    const col = processColors(pType);
    const badge = p.process
      ? `<div class="process-badge" style="background:${col.bg};border-color:${col.br};color:${col.txt}">${escapeHtml(p.process)}</div>`
      : '';

    return `
      <div class="popup-card">
        ${badge}
        ${photo}
        <div class="popup-body">
          <div class="popup-title">${escapeHtml(p.farmName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
          <div class="meta">${place || '‚Äî'}</div>
          ${rows.join('')}
        </div>
      </div>
    `;

    function emojiRow(emoji, title, val){
      return `<div class="row"><span class="row-emoji" title="${escapeAttr(title)}">${emoji}</span><span>${val||''}</span></div>`;
    }
  }

  /* ==== –≥–µ–æ–∫–æ–¥–∏–Ω–≥ –≥–æ—Ä–æ–¥–æ–≤ (–∫–µ—à, –∫–µ–π—Å—ã) ==== */
  const CITY_CACHE_NS = 'coffee_city_cache_v1';
  const cityCache = JSON.parse(localStorage.getItem(CITY_CACHE_NS) || '{}');
  const cacheSave = () => localStorage.setItem(CITY_CACHE_NS, JSON.stringify(cityCache));

  async function geocodeCityName(name){
    const key = String(name||'').trim().toLowerCase();
    if (!key) return null;
    if (cityCache[key]) return cityCache[key];
    const url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' +
      encodeURIComponent(name) + '.json?' + new URLSearchParams({
        access_token: MAPBOX_TOKEN, types: 'place,locality', language: 'ru,en', limit: '1'
      });
    const res = await fetch(url);
    if (!res
